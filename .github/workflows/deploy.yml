name: Deploy to Lightsail

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      branch:
        description: 'ë°°í¬í•  ë¸Œëœì¹˜'
        required: true
        default: 'main'
        type: choice
        options:
          - main

jobs:
  deploy:
    name: ğŸš€ ihavenomenu Lightsail ë°°í¬
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“ ë°°í¬ ì‹œì‘ ë¡œê·¸
        run: |
          echo "ğŸš€ ë°°í¬ ë¸Œëœì¹˜: ${{ github.event.inputs.branch || 'main' }}"
          echo "ğŸ‘¤ ì‹¤í–‰ì: ${{ github.actor }}"
          echo "â° ì‹œê°„: $(date)"

      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || 'main' }}

      - name: ğŸ”§ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ“¦ npm ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci
        working-directory: web

      - name: ğŸ—ï¸ ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ
        run: npm run build
        working-directory: web
        env:
          NODE_ENV: production

      - name: ğŸ“¤ ë¹Œë“œ ê²°ê³¼ë¬¼ ì„œë²„ë¡œ ì „ì†¡
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.LIGHTSAIL_HOST }}
          username: ${{ secrets.LIGHTSAIL_USERNAME }}
          key: ${{ secrets.LIGHTSAIL_SSH_KEY }}
          port: 22
          source: "web/.output,database,ecosystem.config.cjs"
          target: "~/ihavenomenu-tmp"
          rm: true
          strip_components: 0
          timeout: 10m
          command_timeout: 10m

      - name: ğŸ” SSHë¡œ Lightsail ë°°í¬
        uses: appleboy/ssh-action@v1.0.3
        env:
          NUXT_DB_PATH: /var/www/ihavenomenu/database/ihavenomenu.db
          NUXT_JWT_SECRET: ${{ secrets.JWT_SECRET }}
          NUXT_YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
          NUXT_GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          NUXT_GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          NUXT_GOOGLE_REDIRECT_URI: ${{ secrets.GOOGLE_REDIRECT_URI }}
        with:
          host: ${{ secrets.LIGHTSAIL_HOST }}
          username: ${{ secrets.LIGHTSAIL_USERNAME }}
          key: ${{ secrets.LIGHTSAIL_SSH_KEY }}
          port: 22
          envs: NUXT_DB_PATH,NUXT_JWT_SECRET,NUXT_YOUTUBE_API_KEY,NUXT_GOOGLE_CLIENT_ID,NUXT_GOOGLE_CLIENT_SECRET,NUXT_GOOGLE_REDIRECT_URI
          script: |
            echo "ğŸ”§ PM2 ì„¤ì¹˜ í™•ì¸..."
            if ! command -v pm2 &> /dev/null; then
              sudo npm install -g pm2
            fi

            APP_DIR=/var/www/ihavenomenu

            echo "ğŸ“ í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ìƒì„±..."
            cat > $APP_DIR/.env << ENVEOF
            NITRO_PORT=8031
            NODE_ENV=production
            NUXT_DB_PATH=${NUXT_DB_PATH}
            NUXT_JWT_SECRET=${NUXT_JWT_SECRET}
            NUXT_YOUTUBE_API_KEY=${NUXT_YOUTUBE_API_KEY}
            NUXT_GOOGLE_CLIENT_ID=${NUXT_GOOGLE_CLIENT_ID}
            NUXT_GOOGLE_CLIENT_SECRET=${NUXT_GOOGLE_CLIENT_SECRET}
            NUXT_GOOGLE_REDIRECT_URI=${NUXT_GOOGLE_REDIRECT_URI}
            ENVEOF
            sed -i 's/^[[:space:]]*//' $APP_DIR/.env
            chmod 600 $APP_DIR/.env

            echo "ğŸ“‚ ë¹Œë“œ ê²°ê³¼ë¬¼ ì´ë™..."
            sudo cp -r ~/ihavenomenu-tmp/web/.output $APP_DIR/.output-new
            sudo cp -r ~/ihavenomenu-tmp/database $APP_DIR/database-new

            echo "ğŸ“¦ ë„¤ì´í‹°ë¸Œ ëª¨ë“ˆ ì„¤ì¹˜..."
            cd $APP_DIR/.output-new/server
            npm install better-sqlite3

            echo "ğŸ”„ ê¸°ì¡´ ë¹Œë“œ êµì²´..."
            cd $APP_DIR
            rm -rf .output-old database-old
            if [ -d .output ]; then mv .output .output-old; fi
            mv .output-new .output

            # DB ë§ˆì´ê·¸ë ˆì´ì…˜
            if [ ! -f database/ihavenomenu.db ]; then
              echo "ğŸ—„ï¸ ìµœì´ˆ ë°°í¬: DB ë³µì‚¬..."
              mv database-new database
            else
              echo "ğŸ—„ï¸ ê¸°ì¡´ DB ë§ˆì´ê·¸ë ˆì´ì…˜..."
              chmod +x database-new/migrate.sh
              bash database-new/migrate.sh database/ihavenomenu.db database-new/ihavenomenu.db
              rm -rf database-new
            fi

            echo "ğŸ”„ ì•± ì¬ì‹œì‘..."
            sudo chown -R ubuntu:ubuntu $APP_DIR/.output
            pm2 delete ihavenomenu 2>/dev/null || true
            cd $APP_DIR && pm2 start ecosystem.config.cjs

            echo "ğŸ§¹ ì •ë¦¬..."
            rm -rf ~/ihavenomenu-tmp
            rm -rf $APP_DIR/.output-old

            echo "ğŸ“Š ì•± ìƒíƒœ í™•ì¸..."
            sleep 3
            pm2 status
            pm2 save

            echo "âœ… ë°°í¬ ì™„ë£Œ!"

      - name: âœ… ë°°í¬ ì™„ë£Œ ì•Œë¦¼
        run: |
          echo "ğŸ‰ ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
          echo "ğŸ“ ì„œë²„: ${{ secrets.LIGHTSAIL_HOST }}"
          echo "ğŸŒ URL: https://ihavenomenu.com"
          echo "ğŸŒ¿ ë¸Œëœì¹˜: ${{ github.event.inputs.branch || 'main' }}"
