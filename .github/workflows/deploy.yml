name: Deploy to Lightsail

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      branch:
        description: 'ë°°í¬í•  ë¸Œëœì¹˜'
        required: true
        default: 'main'
        type: choice
        options:
          - main

jobs:
  deploy:
    name: ğŸš€ ihavenomenu Lightsail ë°°í¬
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“ ë°°í¬ ì‹œì‘ ë¡œê·¸
        run: |
          echo "ğŸš€ ë°°í¬ ë¸Œëœì¹˜: ${{ github.event.inputs.branch || 'main' }}"
          echo "ğŸ‘¤ ì‹¤í–‰ì: ${{ github.actor }}"
          echo "â° ì‹œê°„: $(date)"

      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || 'main' }}

      - name: ğŸ”§ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ“¦ npm ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci
        working-directory: web

      - name: ğŸ—ï¸ ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ
        run: npm run build
        working-directory: web
        env:
          NODE_ENV: production

      - name: ğŸ“¤ ë¹Œë“œ ê²°ê³¼ë¬¼ ì„œë²„ë¡œ ì „ì†¡
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.LIGHTSAIL_HOST }}
          username: ${{ secrets.LIGHTSAIL_USERNAME }}
          key: ${{ secrets.LIGHTSAIL_SSH_KEY }}
          port: 22
          source: "web/.output,database,ecosystem.config.cjs"
          target: "~/ihavenomenu-tmp"
          rm: true
          strip_components: 0
          timeout: 10m
          command_timeout: 10m

      - name: ğŸ” SSHë¡œ Lightsail ë°°í¬
        uses: appleboy/ssh-action@v1.0.3
        env:
          NUXT_DB_PATH: /var/www/ihavenomenu/database/ihavenomenu.db
          NUXT_JWT_SECRET: ${{ secrets.JWT_SECRET }}
          NUXT_YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
          NUXT_GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          NUXT_GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          NUXT_GOOGLE_REDIRECT_URI: ${{ secrets.GOOGLE_REDIRECT_URI }}
        with:
          host: ${{ secrets.LIGHTSAIL_HOST }}
          username: ${{ secrets.LIGHTSAIL_USERNAME }}
          key: ${{ secrets.LIGHTSAIL_SSH_KEY }}
          port: 22
          envs: NUXT_DB_PATH,NUXT_JWT_SECRET,NUXT_YOUTUBE_API_KEY,NUXT_GOOGLE_CLIENT_ID,NUXT_GOOGLE_CLIENT_SECRET,NUXT_GOOGLE_REDIRECT_URI
          script: |
            echo "ğŸ”§ ì˜ì¡´ì„± í™•ì¸..."
            if ! command -v pm2 &> /dev/null; then
              sudo npm install -g pm2
            fi
            if ! command -v sqlite3 &> /dev/null; then
              echo "ğŸ“¦ sqlite3 ì„¤ì¹˜..."
              sudo apt-get update -qq && sudo apt-get install -y -qq sqlite3
            fi

            APP_DIR=/var/www/ihavenomenu
            sudo mkdir -p $APP_DIR

            echo "ğŸ“ í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ìƒì„±..."
            cat > $APP_DIR/.env << ENVEOF
            NITRO_PORT=8031
            NODE_ENV=production
            NUXT_DB_PATH=${NUXT_DB_PATH}
            NUXT_JWT_SECRET=${NUXT_JWT_SECRET}
            NUXT_YOUTUBE_API_KEY=${NUXT_YOUTUBE_API_KEY}
            NUXT_GOOGLE_CLIENT_ID=${NUXT_GOOGLE_CLIENT_ID}
            NUXT_GOOGLE_CLIENT_SECRET=${NUXT_GOOGLE_CLIENT_SECRET}
            NUXT_GOOGLE_REDIRECT_URI=${NUXT_GOOGLE_REDIRECT_URI}
            ENVEOF
            sed -i 's/^[[:space:]]*//' $APP_DIR/.env
            chmod 600 $APP_DIR/.env

            echo "ğŸ“‚ ë¹Œë“œ ê²°ê³¼ë¬¼ ì´ë™..."
            sudo cp -r ~/ihavenomenu-tmp/web/.output $APP_DIR/.output-new
            sudo cp -r ~/ihavenomenu-tmp/database $APP_DIR/database-new
            sudo cp ~/ihavenomenu-tmp/ecosystem.config.cjs $APP_DIR/ecosystem.config.cjs

            echo "ğŸ“¦ ë„¤ì´í‹°ë¸Œ ëª¨ë“ˆ ì„¤ì¹˜..."
            cd $APP_DIR/.output-new/server
            npm install better-sqlite3

            echo "ğŸ”„ ê¸°ì¡´ ë¹Œë“œ êµì²´..."
            cd $APP_DIR
            rm -rf .output-old
            if [ -d .output ]; then mv .output .output-old; fi
            mv .output-new .output

            # DB ë§ˆì´ê·¸ë ˆì´ì…˜
            if [ ! -f database/ihavenomenu.db ]; then
              echo "ğŸ—„ï¸ ìµœì´ˆ ë°°í¬: DB ë³µì‚¬..."
              sudo mv database-new database
              sudo chown -R ubuntu:ubuntu $APP_DIR/database
            else
              echo "ğŸ—„ï¸ ê¸°ì¡´ DB ë§ˆì´ê·¸ë ˆì´ì…˜..."
              sudo chown -R ubuntu:ubuntu $APP_DIR/database-new
              chmod +x database-new/migrate.sh
              bash database-new/migrate.sh database/ihavenomenu.db database-new/ihavenomenu.db
              if [ $? -ne 0 ]; then
                echo "âš ï¸ ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸ ì‹¤íŒ¨, Node.jsë¡œ ì¬ì‹œë„..."
                node -e "
                  const Database = require('./output/server/node_modules/better-sqlite3');
                  const existDb = new Database('database/ihavenomenu.db');
                  const cols = existDb.pragma('table_info(ingredients)').map(c => c.name);
                  if (!cols.includes('name_ko')) existDb.exec('ALTER TABLE ingredients ADD COLUMN name_ko TEXT');
                  if (!cols.includes('name_en')) existDb.exec('ALTER TABLE ingredients ADD COLUMN name_en TEXT');
                  if (!cols.includes('category_ko')) existDb.exec('ALTER TABLE ingredients ADD COLUMN category_ko TEXT');
                  if (!cols.includes('category_en')) existDb.exec('ALTER TABLE ingredients ADD COLUMN category_en TEXT');
                  if (!cols.includes('parent_id')) existDb.exec('ALTER TABLE ingredients ADD COLUMN parent_id INTEGER');
                  if (!cols.includes('is_base')) existDb.exec('ALTER TABLE ingredients ADD COLUMN is_base BOOLEAN DEFAULT 0');
                  const dCols = existDb.pragma('table_info(dishes)').map(c => c.name);
                  if (!dCols.includes('name_en')) existDb.exec('ALTER TABLE dishes ADD COLUMN name_en TEXT');
                  // ìƒˆ DBì—ì„œ ë°ì´í„° ë³µì‚¬
                  try {
                    existDb.exec(\"ATTACH DATABASE 'database-new/ihavenomenu.db' AS newdb\");
                    existDb.exec('UPDATE ingredients SET name_ko = (SELECT n.name_ko FROM newdb.ingredients n WHERE n.id = ingredients.id), name_en = (SELECT n.name_en FROM newdb.ingredients n WHERE n.id = ingredients.id), category_ko = (SELECT n.category_ko FROM newdb.ingredients n WHERE n.id = ingredients.id), category_en = (SELECT n.category_en FROM newdb.ingredients n WHERE n.id = ingredients.id), parent_id = (SELECT n.parent_id FROM newdb.ingredients n WHERE n.id = ingredients.id), is_base = (SELECT n.is_base FROM newdb.ingredients n WHERE n.id = ingredients.id) WHERE EXISTS (SELECT 1 FROM newdb.ingredients n WHERE n.id = ingredients.id)');
                    existDb.exec(\"DETACH DATABASE newdb\");
                    console.log('Node.js ë§ˆì´ê·¸ë ˆì´ì…˜ ì„±ê³µ');
                  } catch(e) { console.error('ë°ì´í„° ë³µì‚¬ ì‹¤íŒ¨:', e.message); }
                  existDb.close();
                " 2>&1 || echo "âš ï¸ Node.js ë§ˆì´ê·¸ë ˆì´ì…˜ë„ ì‹¤íŒ¨"
              fi
              rm -rf database-new
            fi

            echo "ğŸ”„ ì•± ì¬ì‹œì‘..."
            sudo chown -R ubuntu:ubuntu $APP_DIR/.output
            sudo chown -R ubuntu:ubuntu $APP_DIR/database
            pm2 delete ihavenomenu 2>/dev/null || true
            cd $APP_DIR && pm2 start ecosystem.config.cjs

            echo "ğŸ§¹ ì •ë¦¬..."
            rm -rf ~/ihavenomenu-tmp
            rm -rf $APP_DIR/.output-old

            echo "ğŸ“Š ì•± ìƒíƒœ í™•ì¸..."
            sleep 3
            pm2 status
            pm2 save

            # API í—¬ìŠ¤ì²´í¬
            echo "ğŸ” API í—¬ìŠ¤ì²´í¬..."
            sleep 2
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8031/api/ingredients/base 2>/dev/null || echo "000")
            if [ "$HTTP_CODE" = "200" ]; then
              echo "âœ… API ì •ìƒ (HTTP $HTTP_CODE)"
            else
              echo "âš ï¸ API ì‘ë‹µ ë¹„ì •ìƒ (HTTP $HTTP_CODE)"
              pm2 logs ihavenomenu --lines 20 --nostream
            fi

            echo "âœ… ë°°í¬ ì™„ë£Œ!"

      - name: âœ… ë°°í¬ ì™„ë£Œ ì•Œë¦¼
        run: |
          echo "ğŸ‰ ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
          echo "ğŸ“ ì„œë²„: ${{ secrets.LIGHTSAIL_HOST }}"
          echo "ğŸŒ URL: https://ihavenomenu.com"
          echo "ğŸŒ¿ ë¸Œëœì¹˜: ${{ github.event.inputs.branch || 'main' }}"
