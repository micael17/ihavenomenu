name: Deploy to Lightsail

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      branch:
        description: 'ë°°í¬í•  ë¸Œëœì¹˜'
        required: true
        default: 'main'
        type: choice
        options:
          - main

jobs:
  deploy:
    name: ğŸš€ ihavenomenu Lightsail ë°°í¬
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“ ë°°í¬ ì‹œì‘ ë¡œê·¸
        run: |
          echo "ğŸš€ ë°°í¬ ë¸Œëœì¹˜: ${{ github.event.inputs.branch || 'main' }}"
          echo "ğŸ‘¤ ì‹¤í–‰ì: ${{ github.actor }}"
          echo "â° ì‹œê°„: $(date)"

      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || 'main' }}

      - name: ğŸ”§ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ“¦ npm ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci
        working-directory: web

      - name: ğŸ—ï¸ ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ
        run: npm run build
        working-directory: web
        env:
          NODE_ENV: production

      - name: ğŸ“¤ ë¹Œë“œ ê²°ê³¼ë¬¼ ì„œë²„ë¡œ ì „ì†¡
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.LIGHTSAIL_HOST }}
          username: ${{ secrets.LIGHTSAIL_USERNAME }}
          key: ${{ secrets.LIGHTSAIL_SSH_KEY }}
          port: 22
          source: "web/.output,database,ecosystem.config.cjs"
          target: "~/ihavenomenu-tmp"
          rm: true
          strip_components: 0
          timeout: 10m
          command_timeout: 10m

      - name: ğŸ” SSHë¡œ Lightsail ë°°í¬
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.LIGHTSAIL_HOST }}
          username: ${{ secrets.LIGHTSAIL_USERNAME }}
          key: ${{ secrets.LIGHTSAIL_SSH_KEY }}
          port: 22
          script: |
            echo "ğŸ”§ PM2 ì„¤ì¹˜ í™•ì¸..."
            if ! command -v pm2 &> /dev/null; then
              sudo npm install -g pm2
            fi

            APP_DIR=/var/www/ihavenomenu

            echo "ğŸ“‚ ë¹Œë“œ ê²°ê³¼ë¬¼ ì´ë™..."
            sudo cp -r ~/ihavenomenu-tmp/web/.output $APP_DIR/.output-new
            sudo cp -r ~/ihavenomenu-tmp/database $APP_DIR/database-new

            echo "ğŸ“¦ ë„¤ì´í‹°ë¸Œ ëª¨ë“ˆ ì„¤ì¹˜..."
            cd $APP_DIR/.output-new/server
            npm install better-sqlite3

            echo "ğŸ”„ ê¸°ì¡´ ë¹Œë“œ êµì²´..."
            cd $APP_DIR
            rm -rf .output-old database-old
            if [ -d .output ]; then mv .output .output-old; fi
            mv .output-new .output

            # DBëŠ” ìµœì´ˆ ë°°í¬ ì‹œì—ë§Œ ë³µì‚¬ (ê¸°ì¡´ DB ë³´ì¡´)
            if [ ! -f database/ihavenomenu.db ]; then
              echo "ğŸ—„ï¸ ìµœì´ˆ ë°°í¬: DB ë³µì‚¬..."
              mv database-new database
            else
              echo "ğŸ—„ï¸ ê¸°ì¡´ DB ìœ ì§€..."
              rm -rf database-new
            fi

            echo "ğŸ“ í™˜ê²½ë³€ìˆ˜ íŒŒì¼ í™•ì¸..."
            if [ ! -f .env ]; then
              echo "âš ï¸  .env íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ì„œë²„ì— ì§ì ‘ ìƒì„±í•´ì£¼ì„¸ìš”."
              exit 1
            fi

            echo "ğŸ”„ ì•± ì¬ì‹œì‘..."
            sudo chown -R ubuntu:ubuntu $APP_DIR/.output
            pm2 restart ihavenomenu || pm2 start ecosystem.config.cjs

            echo "ğŸ§¹ ì •ë¦¬..."
            rm -rf ~/ihavenomenu-tmp
            rm -rf $APP_DIR/.output-old

            echo "ğŸ“Š ì•± ìƒíƒœ í™•ì¸..."
            sleep 3
            pm2 status
            pm2 save

            echo "âœ… ë°°í¬ ì™„ë£Œ!"

      - name: âœ… ë°°í¬ ì™„ë£Œ ì•Œë¦¼
        run: |
          echo "ğŸ‰ ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
          echo "ğŸ“ ì„œë²„: ${{ secrets.LIGHTSAIL_HOST }}"
          echo "ğŸŒ URL: https://ihavenomenu.com"
          echo "ğŸŒ¿ ë¸Œëœì¹˜: ${{ github.event.inputs.branch || 'main' }}"
